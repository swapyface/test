import pandas as pd

# Assuming you have already loaded your two DataFrames as df_uat and df_prod
# For demonstration purposes, let's create sample DataFrames:
data_uat = {'item_id': [1, 1, 2, 3],
            'category': ['A', 'A', 'B', 'C'],
            'product_name': ['Product X', 'Product Y', 'Product Z', 'Product W'],
            'price': [10.0, 20.5, 15.0, 25.0],
            'other_col_uat': [100, 200, 300, 400]}
df_uat = pd.DataFrame(data_uat)

data_prod = {'item_id': [1, 2, 2, 3],
             'category': ['A', 'B', 'B', 'C'],
             'product_name': ['Product X', 'Product Z', 'Product ZZ', 'Product W'],
             'price': [10.0, 15.0, 16.0, 25.0],
             'other_col_prod': [500, 600, 700, 800]}
df_prod = pd.DataFrame(data_prod)

key_columns = ["item_id", "category", "product_name"]
price_column = "price"

# Merge the two DataFrames based on the key columns
merged_df = pd.merge(df_uat, df_prod, on=key_columns, suffixes=('_uat', '_prod'), how='outer')

# Create 'comment' and 'price_difference' columns
merged_df['comment'] = ''
merged_df['price_difference'] = None

# Identify rows present in both DataFrames
both_files_mask = merged_df['_merge'] == 'both'

# Calculate price difference and add comments for mismatches
price_uat_col = f"{price_column}_uat"
price_prod_col = f"{price_column}_prod"

# Calculate difference where both prices are present
both_prices_present = both_files_mask & ~pd.isna(merged_df[price_uat_col]) & ~pd.isna(merged_df[price_prod_col])
merged_df.loc[both_prices_present & (merged_df[price_uat_col] != merged_df[price_prod_col]), 'price_difference'] = abs(merged_df[price_uat_col] - merged_df[price_prod_col])
merged_df.loc[both_prices_present & (merged_df[price_uat_col] != merged_df[price_prod_col]), 'comment'] = 'Price mismatch'

# Add comments for missing prices
merged_df.loc[both_files_mask & pd.isna(merged_df[price_uat_col]) & ~pd.isna(merged_df[price_prod_col]), 'comment'] = 'Price mismatch (missing in UAT)'
merged_df.loc[both_files_mask & ~pd.isna(merged_df[price_uat_col]) & pd.isna(merged_df[price_prod_col]), 'comment'] = 'Price mismatch (missing in PROD)'

# Identify rows missing in UAT
missing_in_uat_mask = merged_df['_merge'] == 'right_only'
merged_df.loc[missing_in_uat_mask, 'comment'] = 'Missing row in UAT'

# Identify rows missing in PROD
missing_in_prod_mask = merged_df['_merge'] == 'left_only'
merged_df.loc[missing_in_prod_mask, 'comment'] = 'Missing row in PROD'

# Print the merged DataFrame with the comment and price difference columns
print(merged_df[['item_id', 'category', 'product_name', price_uat_col, price_prod_col, 'price_difference', 'comment']])

# If you want to save this to a new Excel file:
# merged_df.to_excel("comparison_with_diff_comments.xlsx", index=False)

